<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirection...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* Couche transparente invisible */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Petit indicateur de chargement (optionnel, peut √™tre retir√©) */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(139, 92, 246, 0.2);
            border-top: 3px solid rgb(139, 92, 246);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none; /* Masqu√© par d√©faut pour rester transparent */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://clptftnsvknadrfgxpuw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNscHRmdG5zdmtuYWRyZmd4cHV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIyNDg5ODYsImV4cCI6MjA1NzgyNDk4Nn0.GnDSQHTv2fUg3aWytpuk9zDdZDc30KZaTbmqbZh4W44';

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const utm_source = urlParams.get('utm_source');
        const utm_medium = urlParams.get('utm_medium');
        const utm_campaign = urlParams.get('utm_campaign');
        const utm_content = urlParams.get('utm_content');
        const ebook_id = urlParams.get('ebook_id');
        const campaign_id = urlParams.get('campaign_id');
        const should_deep_link = urlParams.get('deep_link');

        console.log('üöÄ Landing page loaded');
        console.log('üìä Campaign ID:', campaign_id);
        console.log('üì± Device:', getDeviceType());

        // Initialize page immediately
        (async function() {
            // Track click
            await trackClick();

            // Store attribution data
            storeAttributionData();

            // Attempt redirection
            if (should_deep_link === 'true') {
                attemptDeepLink();
            } else {
                // Si pas de deep link, rediriger vers le store directement
                redirectToStore();
            }
        })();

        function storeAttributionData() {
            if (campaign_id) {
                const attributionData = {
                    campaign_id: campaign_id,
                    utm_source: utm_source,
                    utm_medium: utm_medium,
                    utm_campaign: utm_campaign,
                    utm_content: utm_content,
                    ebook_id: ebook_id,
                    click_timestamp: new Date().toISOString(),
                    referrer_url: document.referrer
                };

                localStorage.setItem('campaign_attribution', JSON.stringify(attributionData));
                console.log('üìä Attribution data stored:', attributionData);
            }
        }

        async function trackClick() {
            try {
                console.log('üîç Tracking click...');

                if (!campaign_id) {
                    console.log('‚ö†Ô∏è No campaign_id, skipping tracking');
                    return;
                }

                const deviceType = getDeviceType();

                // D√©tecter si c'est une r√©ouverture d'app ou une redirection vers le store
                const clickType = (deviceType === 'mobile' || deviceType === 'tablet') &&
                                 document.referrer.includes('ebooks://') ? 'app_open' : 'playstore_open';

                console.log('üìç Click type:', clickType);

                // R√©cup√©rer le post_id depuis campaign_social_posts
                const postResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/campaign_social_posts?campaign_id=eq.${campaign_id}&select=id`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!postResponse.ok) {
                    console.error('‚ùå Failed to fetch social post:', postResponse.status);
                    return;
                }

                const posts = await postResponse.json();
                if (!posts || posts.length === 0) {
                    console.error('‚ùå No social post found for campaign:', campaign_id);
                    return;
                }

                const socialPostId = posts[0].id;
                console.log('‚úÖ Found social post ID:', socialPostId);

                // Track click
                const response = await fetch(`${SUPABASE_URL}/rest/v1/campaign_clicks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        campaign_social_post_id: socialPostId,
                        click_type: clickType,
                        user_agent: navigator.userAgent,
                        referer_url: document.referrer || '',
                        device_type: deviceType,
                        browser: getBrowserName(),
                        os: getOSName()
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Click tracked successfully as:', clickType);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to track click:', response.status, errorText);
                }
            } catch (error) {
                console.error('‚ùå Error tracking click:', error);
            }
        }

        function attemptDeepLink() {
            const deviceType = getDeviceType();
            console.log('üîó Attempting deep link - Device:', deviceType);

            // Seulement essayer le deep link sur mobile/tablet
            if (deviceType === 'mobile' || deviceType === 'tablet') {
                const deepLinkParams = new URLSearchParams();
                if (utm_source) deepLinkParams.append('utm_source', utm_source);
                if (utm_medium) deepLinkParams.append('utm_medium', utm_medium);
                if (utm_campaign) deepLinkParams.append('utm_campaign', utm_campaign);
                if (utm_content) deepLinkParams.append('utm_content', utm_content);
                if (ebook_id) deepLinkParams.append('ebook_id', ebook_id);
                if (campaign_id) deepLinkParams.append('campaign_id', campaign_id);

                const deepLinkUrl = `ebooks://?${deepLinkParams.toString()}`;
                console.log('üîó Deep link URL:', deepLinkUrl);

                // Essayer d'ouvrir l'app
                window.location.href = deepLinkUrl;

                // Si l'app ne s'ouvre pas, rediriger vers le store apr√®s un d√©lai
                setTimeout(() => {
                    console.log('üîó Deep link timeout, redirecting to store...');
                    redirectToStore();
                }, 2000);
            } else {
                console.log('üñ•Ô∏è Desktop detected, redirecting to store...');
                redirectToStore();
            }
        }

        function redirectToStore() {
            const isAndroid = /Android/.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);

            if (isAndroid) {
                console.log('üì± Redirecting to Play Store...');
                window.location.href = 'https://play.google.com/store/apps/details?id=com.poyah.ebooksapp';
            } else if (isIOS) {
                console.log('üì± Redirecting to App Store...');
                window.location.href = 'https://apps.apple.com/app/your-app-id';
            } else {
                console.log('üñ•Ô∏è Desktop - showing alert...');
                alert('T√©l√©chargez notre app sur iOS App Store ou Google Play Store\n\nAndroid: https://play.google.com/store/apps/details?id=com.poyah.ebooksapp');
            }
        }

        function getDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet|kindle|silk|phone/i;
            const isIOS = /ipad|iphone|ipod/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isAndroid = /android/.test(userAgent);
            const isTablet = /ipad|tablet|kindle|silk/.test(userAgent) || (isAndroid && !/mobile/.test(userAgent));

            if (isIOS || isAndroid || mobileRegex.test(userAgent)) {
                return isTablet ? 'tablet' : 'mobile';
            }
            return 'desktop';
        }

        function getBrowserName() {
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome') && !userAgent.includes('Edge')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            if (userAgent.includes('Opera')) return 'Opera';
            return 'Other';
        }

        function getOSName() {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;

            if (/iPad|iPhone|iPod/.test(userAgent) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
                return 'iOS';
            }
            if (userAgent.includes('Android')) return 'Android';
            if (userAgent.includes('Windows')) return 'Windows';
            if (userAgent.includes('Mac') && !userAgent.includes('iPhone')) return 'macOS';
            if (userAgent.includes('Linux')) return 'Linux';
            return 'Other';
        }
    </script>
</body>
</html>